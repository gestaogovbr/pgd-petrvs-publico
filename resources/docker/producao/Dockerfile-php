# syntax=docker/dockerfile:1
FROM php:8.2-apache
ARG ELASTIC_APM_ENABLED=false

# Instalar recursos adicionais
RUN apt-get update && apt-get install -y \
    sed \
    vim \
    git \
    zlib1g-dev \
    libzip-dev \
    unzip \
    curl \
    ca-certificates \
    libcurl4-openssl-dev \
    openssl \
    libssl-dev \
    libxml2-dev \
    sudo \
    chrony \
    && docker-php-ext-install zip \
    pdo_mysql \
    mysqli \
    soap \
    curl \
    calendar \
    && docker-php-ext-enable pdo_mysql \
    && rm -rf /var/lib/apt/lists/*

# Instalar openssl utilizando um workaround
RUN docker-php-ext-install openssl || true && \
    cp /usr/src/php/ext/openssl/config0.m4 /usr/src/php/ext/openssl/config.m4 && \
    docker-php-ext-install openssl

# Instalar extensões via PECL
RUN pecl install redis inotify && \
    docker-php-ext-enable redis inotify

RUN curl -L https://apm-agent-php.elastic.co/install.sh | bash -s -- --version 1.15.1 || true && \
    if [ -d "/opt/elastic/apm-agent-php" ]; then \
      EXT_DIR=$(php -r 'echo ini_get("extension_dir");'); \
      if [ -f "/opt/elastic/apm-agent-php/extensions/$(php -r 'echo PHP_ZTS?"zts":"no-zts";')-$(php -r 'echo PHP_MAJOR_VERSION.PHP_MINOR_VERSION;')/elastic_apm.so" ]; then \
        cp /opt/elastic/apm-agent-php/extensions/$(php -r 'echo PHP_ZTS?"zts":"no-zts";')-$(php -r 'echo PHP_MAJOR_VERSION.PHP_MINOR_VERSION;')/elastic_apm.so "$EXT_DIR/elastic_apm.so"; \
      fi; \
      echo "extension=elastic_apm.so\nelastic_apm.bootstrap_php_part_file=/opt/elastic/apm-agent-php/src/bootstrap_php_part.php" > /usr/local/etc/php/conf.d/elastic-apm.ini; \
    fi

ENV ELASTIC_APM_ENABLED=${ELASTIC_APM_ENABLED} \
    ELASTIC_APM_ENVIRONMENT=prd \
    ELASTIC_APM_SERVICE_NAME=pdg \
    ELASTIC_APM_SECRET_TOKEN=prd_token_apm_elk \
    ELASTIC_APM_SERVER_URL=http://n221p044341.fast.prevnet:8200 \
    ELASTIC_APM_GLOBAL_LABELS=cliente=mgi,categoria=backend

# Criar diretório DocumentRoot e /etc/apache2/ssl
WORKDIR /var/www
VOLUME /var/www
RUN mkdir /etc/apache2/ssl

# Copiar arquivos de configuração e certificado digital
COPY ./configuracoes/apache2/apache2.conf /etc/apache2/apache2.conf
COPY ./configuracoes/php/php_production.ini /usr/local/etc/php/php.ini
COPY ./configuracoes/php/cacert.pem /usr/local/etc/php/cacert.pem
COPY ./configuracoes/apache2/ssl-params.conf /etc/apache2/conf-available/ssl-params.conf
COPY ./configuracoes/apache2/000-default.conf /etc/apache2/sites-available/000-default.conf
COPY ./configuracoes/apache2/default-ssl.conf /etc/apache2/sites-available/default-ssl.conf
COPY ./configuracoes/certificados/certificate.crt /etc/apache2/ssl/certificate.crt
COPY ./configuracoes/certificados/private.key /etc/apache2/ssl/private.key
COPY ./configuracoes/chrony/chrony.conf /etc/chrony/chrony.conf
COPY ./configuracoes/scripts/setup_production.sh /root/setup_production.sh
COPY ./slowlogwatch.conf /etc/supervisor/conf.d/slowlogwatch.conf

# Instalar o composer
RUN php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');" && \
    php composer-setup.php --install-dir=/usr/local/bin --filename=composer && \
    rm composer-setup.php

# Habilitar módulos e configurações no apache2
RUN a2enconf ssl-params && \
    a2enmod ssl rewrite headers && \
    a2ensite default-ssl

# Rodar script com configurações do modo produção
RUN service chrony restart

RUN chmod a+x /root/setup_production.sh && \
    /root/setup_production.sh

# Garantir existência do mysql-slow.log com permissão correta
RUN mkdir -p /var/www/storage/logs && \
    touch /var/www/storage/logs/mysql-slow.log && \
    chmod 660 /var/www/storage/logs/mysql-slow.log
